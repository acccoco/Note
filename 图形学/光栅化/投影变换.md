投影变换将坐标从「view space」变换到「clip space」
根据不同的「view space」和「clip space」设置，可以得到不同的变换矩阵

**观察空间**：
一般来说，「view space」坐标系是以摄像机为原点，摄像机朝向为 `-z`建立的，是「右手系」，例如：（灰色区域表示可见范围）
![[图形学/光栅化/_attachments/u66d4dfd0_image.png | 195]]


### 正交投影变换
示意图：从正交投影的长方体视野范围变换为 NDC 的正方体，坐标系从右手系变换为左手系。
![[图形学/光栅化/_attachments/u3f900d32_image.png | 499]]

「view space」到「clip space」的变换矩阵为：
$$M_{proj} =
\begin{bmatrix}
\frac{2}{w} && 0 && 0 && 0 \\
0 && \frac{2}{h} && 0 && 0 \\
0 && 0 && \frac{-2}{f-n} && -\frac{f+n}{f-n} \\
0 && 0 && 0 && 1
\end{bmatrix}$$

其中：

- $w,\ h$ 分别表示 frustum 的宽度和高度
- $n,\ f$ 分别表示 frustum 近平面到摄像机的距离和远平面到摄像机的距离，是**正数**。

「view space」中任意坐标 $(x_e,\ y_e,\ z_e,\ 1)$ 左乘该矩阵，可以得到对应的在「clip space」中的坐标：
$$(\frac{2}{w}x_e,\ \frac{2}{h}y_e,\ \frac{-2}{f-n}z_e-\frac{f+n}{f-n},\ 1)$$

- 坐标的 $w$ 分量是 $1$ ，意味着经过透视除法后结果不变，因此这个坐标同时也是 NDC 中的坐标。
- 从 NDC 的坐标形式可以看出，从「view space」到 NDC 的变换是**线性变换**。



### 透视投影
透视投影的示意图：从棱台形状的视野范围变成正方体形状的 NDC 区域，从右手系变换为左手系。
![[图形学/光栅化/_attachments/ItNkf_gl_projectionmatrix01.png | 544]]

「view space」到「clip space」的变换矩阵为：
$$M_{proj} =
\begin{bmatrix}
\frac{2n}{w} && 0 && 0 && 0 \\
0 && \frac{2n}{h} && 0 && 0 \\
0 && 0 && \frac{-(f+n)}{f-n} && \frac{-2fn}{f-n} \\
0 && 0 && -1 && 0
\end{bmatrix}$$

其中：

- $w,\ h$ 分别表示 frustum 近平面的宽度和高度
- $n,\ f$ 分别表示 frustum 近平面到摄像机的距离和远平面到摄像机的距离，是**正数**

「view space」中的坐标 $(x_e,\ y_e,\ z_e,\ 1)$ 左乘该矩阵可以得到在「clip space」中的坐标：
$$(\frac{2n}{-z_ew}x_e,\
\frac{2n}{-z_e h}y_e,\
\frac{(f+n)(-z_e) +(-2fn)}{f-n},\
-z_e)$$

之后进行透视除法，得到 NDC 中的坐标：
$$(\frac{2n}{w}x_e,\ \frac{2n}{h}y_e,\
\frac{(f+n)z_e + 2fn}{(f-n)z_e},\
1)$$

从上面的表达式可以看出：

- 从「view space」到 NDC 的变换**不是线性变换**。
- 「clip space」坐标的 $w$ 分量是一个**正数**，是点到摄像机平面的**"**距离**"**。
> 上面表达式有些复杂，可以带入近平面值验证一下：「view space」近平面中心点坐标$(0,\ 0,\ -n,\ 1)$ 变换到 NDC 后为：$(0,\ 0,\ -1,\ 1)$ 



**透视投影变换深度的精度问题**：
「view space」中近平面和远平面在 NDC 中对应的 $z$ 值分别是 $-1$ 和 $1$ ，其对应关系为：
$$z_{NDC} = \frac{(f+n)z_e + 2fn}{(f-n)z_e} $$
![[图形学/光栅化/_attachments/d4dG4_image.png | 371]]
可以看到，靠近近平面，深度值的精度越高。


### 参考

- [http://www.songho.ca/opengl/gl_projectionmatrix.html](http://www.songho.ca/opengl/gl_projectionmatrix.html) 投影矩阵的推导过程
