
### 任意切线坐标系
基于法线建立局部坐标系：
已知法线向量 $N$ ，再找一个与其不共线的参考向量 $up$ ，然后基于此建立局部坐标系。
代码如下：
![[图形学/misc/_attachments/u719b7187_image.png | 396]]

切线空间的三个基向量为 `TangentX, TangentY, N`



### 基于纹理建立切线空间
用一句话概括就是：根据纹理的走向来生成 `tangent`向量和 `bitangent`向量。
这样做的好处是，无论物体如何旋转，切线坐标系始终是固定在物体表面的，即使物体发生形变，切线空间也是可靠的。


#### 推导过程
由于三角形位于一个平面中，因此至少**只需要** $2$ 个基向量就可以完整表示出三角形的三条边。
现有两组基向量：

- 沿着 UV 的基向量 $\vec{u},\ \vec{v}$ 
- 模型局部坐标系的基向量：$\vec{x},\ \vec{y},\ \vec{z}$ 

目标是使用$\vec{x},\ \vec{y},\ \vec{z}$ 将$\vec{u},\ \vec{v}$ 表示出来。


首先分别用 UV 基向量和局部坐标系下表示出三角形的边：
![[图形学/misc/_attachments/u76ed7053_应=(a》( An）.png | 392]]

组合两条边的方程，可以得到一个矩阵方程，解方程，将$\vec{u},\ \vec{v}$ 用$\vec{x},\ \vec{y},\ \vec{z}$ 表示出来：
![[图形学/misc/_attachments/u29b984ce_Pasted Graphic 1.png | 446]]

最后只需要正交化处理就可以得到切线空间的基向量了。



### 法线贴图
通常情况下，建模软件会为每个顶点生成 `tangent, normal`向量。
这里介绍如何根据法线贴图得到某个 fragment 的法向量。

```glsl
// 顶点的数据
in struct appdata {
	vec3 normal;	// 顶点法线
    vec4 tangent;	// 顶点 tengent 向量
    vec2 uv;
};

out struct v2f {
    mat3 TBN;
    vec2 uv;
};

v2f vert(appdata i)
{
    v2f o;
    
    mat3 model_iv = transpose(inverse(mat3(model)));
    // 注意两者变换矩阵的差别
    vec3 world_normal = normalize(model_iv * i.normal);
    vec3 world_tangent = normalize(mat3(model) * i.tangent.xyz);
    // 顶点的 tangent 的 w 分量表示符号位
    vec3 world_bitangent = cross(world_normal, world_tangent) * i.tangent.w;
	o.TBN = mat3(world_tangent, world_bitangent, world_normal);

    o.uv = i.uv;

    return o;
}

vec4 frag(v2f i)
{
	// 普通的法线贴图
    vec3 normal_tangent = texture(normal_map, i.uv).rgb * 2.0 - 1.0;
    vec3 world_normal = normalize(i.TBN * normal_tangent);
}
```

> 注：gltf 提到如何计算 `bitangent`向量：![[图形学/misc/_attachments/u5936e39a_image.png | 584]]

[learnopengl | normal mapping](https://learnopengl.com/Advanced-Lighting/Normal-Mapping)
