
### 复数与二维旋转缩放

> [!note] 如何表示二维的旋转缩放
> 只要两个参数即可表示，一个参数表示等比缩放的比例 $s$ ，另一个参数表示旋转的角度 $\theta$ 
> 
> 注：任意一个二维向量都可以表示二维的缩放和旋转

用复数表示旋转的优点在于：旋转变换直接对应==**复数的乘法**== 

复数作为一个二维向量，当然可以表示二维的缩放与旋转。复数可以写成如下形式：
$$z = s(\cos\theta + \sin\theta\cdot i)$$

其中 $\theta$  是旋转角度，$s$  是缩放比例

例如：旋转前的向量对应的复数为 $v = \cos\theta + i\sin\theta$ ，旋转角度为 $\varphi$ ，旋转变换对应的复数为 $z=\cos\varphi + \sin\varphi$ ，则旋转后的向量为：

![[图形学/misc/_attachments/Pasted image 20221105151232.png | 200]]

$$v'= z\cdot v = \cos(\theta + \varphi) + \sin(\theta + \varphi) i$$



### 四元数表示三维旋转

> [!note] 如何表示三维的旋转
> 为了表示三维的旋转，至少需要一个转轴和一个旋转角度
> 
> 因此：任何一个三位旋转可以用一个 4 维向量表示，且可以保证不同的旋转对应不同的向量。

四元数表示三维旋转变换的优势在于：三位旋转变换直接对应==**四元数乘法**==。

四元数表示旋转的其他优点：

- 复合旋转计算速度更快，数值更稳定。
- 提取旋转的角度和轴更简单。
- 插值更直接。参见例如[slerp](https://en.wikipedia.org/wiki/Slerp)。
- 四元数不会像欧拉角那样受到[万向节锁定的影响](https://en.wikipedia.org/wiki/Gimbal_lock)。


#### 向量与转轴垂直

设转轴为 $\vec{u}$ ，旋转前的向量为 $\vec{v}$ ，旋转后的向量为 $\vec{v}'$ 。向量与转轴垂直

旋转对应的四元数为 $q = [\cos\theta,\ \sin\theta\ \vec{u}]$ 

旋转后的向量可以简单地根据四元数乘法计算出：

$$
v' = q\ [0,\ \vec{v}] = [0,\ \cos\theta\ \vec{v} + \sin\theta\ \vec{u}\times\vec{v}]
$$

结果与 [[图形学/misc/运动与旋转/Axis-angle 旋转|Axis-angle]] 形式一致。

#### 向量不与转轴垂直

$\vec{v}$  表示旋转前的向量，$\vec{u}$  表示转轴，$\vec{v'}$ 表示旋转后的向量。（其中 $\vec{u}$  是单位向量）

那么旋转后的向量可以表示为：
$$v' = qvq^{-1}$$

其中 $q = [\cos\frac{\theta}{2},\ \sin\frac{\theta}{2}\ \vec{u}]$ （$q$ 是单位四元数，逆等于共轭 $q^{-1}=q^*$ ）

上述公式根据四元数乘法的性质，很容易证明。最终得到的结果和 [[图形学/misc/运动与旋转/Axis-angle 旋转| Axis-angle]] 形式一致。

上述公式还可以写成如下形式：（其中，$\vec{v}_{\parallel}$ 是 $\vec{v}$ 中与转轴 $\vec{u}$ 平行的分量）

$$
\vec{v'} 
= q\ \vec{v}\ q^{-1} 
= q\ q^{-1}\ \vec{v_{\parallel}} + q\ q\ \vec{v_{\perp}} 
= \vec{v_{\parallel}} + qq\vec{v_{\perp}}
$$

可以这样理解：

- 对于向量 $\vec{v}$  中平行于转轴的部分，不被旋转影响；
- 对于向量 $\vec{v}$ 中垂直于转轴的部分，对其旋转两次，每次旋转 $\frac{\theta}{2}$ 角度


#### 四元数和旋转的对应关系

每个单位四元数都可以写成 $[\cos \frac{\theta}{2},\ \sin\frac{\theta}{2} \vec{u}]$ 的形式，都对应着一个旋转变换

从取值范围可以看出，四元数可以表示 $0\sim 720^\circ$  的旋转，因此关于旋转轴 $\vec{u}$  进行 $\theta$ 的旋转可以用两个四元数来表示，这两个四元数恰好相反：

$$q_1 = [\cos\frac{\theta}{2},\ \sin\frac{\theta}{2}\vec{u}]$$
$$q_2 = [\frac{\theta + 2\pi}{2},\ \sin\frac{\theta + 2 \pi}{2} \vec{u}] = [-\cos\frac{\theta}{2},\ -\sin\frac{\theta}{2}\vec{u}] = -q_1$$ 

可以得到这样的结论：
- **任何一个旋转都可以用单位四元数表示**
- **对于每个旋转，都可以找到一对相反的四元数与之对应**



### 根据四元数得到旋转矩阵

如何得到旋转后的向量：

- 在代码中实现四元数的运算，将向量视为四元数，直接使用四元数乘法得到旋转后的向量
- 也可以将四元数转化为对应的矩阵，然后矩阵乘以向量得到旋转后的向量

四元数的乘法也可以用矩阵来表示，左乘一个四元数 $q=[a,\ (b,\ c,\ d)]$ 相当于左乘矩阵：
$$L(q) =
\begin{bmatrix}
a && -b && -c && -d \\
b && a && -d && c \\
c && d && a && -b \\
d && -c && b && a
\end{bmatrix}$$

右乘四元数相当于右乘矩阵：
$$R(q) = 
\begin{bmatrix}
a && -b && -c && -d \\
b && a && d && -c \\
c && -d && a && b \\
d && c && -b && a
\end{bmatrix}$$

将之前的四元数旋转公式 $v' = qvq^{*}$  用矩阵的形式表示出来，就成了：（$q$  是单位四元数）

![[图形学/misc/_attachments/ua590190a_Pasted Graphic.png | 507]]


### 四元数旋转的复合

设第一次旋转对应的四元数为 $q_1$ ，第二次旋转对应四元数为 $q_2$ 

向量 $v$ 经过两次旋转，得到了向量 $v'$ ：（注：这里用到了 $(q_1q_2)^* = q_2^* \ q_1^*$ 的性质）

$$
v' = q_2\ (q_1\ v\ q_1^*)\ q_2^* = (q_2 q_1)\ v\ (q_2q_1)^*
$$

从上面表达式可以看出，两次旋转变换的复合变换，也是一个旋转变换，对应四元数为 $q_2q_1$  




### 代码实现
使用四元数来表示摄像机的位姿，四元数应用到初始 `front` 向量上，就能得到当前的 `front` 向量。
旋转会改变四元数，将旋转对应的四元数和之前的四元数做四元数乘法，就得到当前的表示位姿的四元数。
可以参考：[https://www.cnblogs.com/Yuri/archive/2007/07/01/802376.html](https://www.cnblogs.com/Yuri/archive/2007/07/01/802376.html)


> [!note] 参考
> - [[图形学/misc/_attachments/quaternion.pdf|krasjet - quaternion]] 包括欧拉角，罗德里格斯，四元数，四元数插值


### 四元数的运算律

四元数可以表示为
$$q = [s,\ \vec{v}]$$

其中，$s$  是实部，$\vec{v}$  是虚部；虚部有三个分量，其单位分别是 $i,\; j,\; k$  

也就是：$q = s + v_x\ i + v_y\ j + v_z\ k$ 

**基本运算**：
$$i^2 = j^2 = k^2 = ijk = -1$$
$$ij = k,\; 
ik = -j,\;
jk = i$$ 

**乘法**：（不满足交换律，满足结合律和分配律）

若 $p = [s,\ \vec{u}]$ ，$q = [t,\ \vec{v}]$ ，则有：

$$pq = [st - \vec{u} \cdot \vec{v},\ s\vec{v} + t\vec{u} + \vec{u} \times \vec{v}] $$

**逆运算**：$q^{-1}q = 1$ 

**共轭四元数**：四元数$q = [s,\ \vec{v}]$ 的共轭四元数为 $q^* = [s,\ -\vec{v}]$ 。

共轭四元数的性质：$qq^* = [s^2 + \vec{v}^2,\ 0] = ||q||^2$ （共轭的乘积只剩实部，大小恰好是四元数模长的平方）

根据共轭乘积的结果，可以得到四元数**求逆**的一种方法：$q^{-1} = \frac{q^*}{||q||^2}$ 
