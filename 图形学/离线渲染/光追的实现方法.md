

## 基本方法

最基本的方法就是，根据 Monte Carlo 积分方法，选择一个以反射方向 $\omega$ 为随机变量的概率密度函数，进行积分。

$$
L_o = \frac{1}{n}\sum_{k = 1}^{n} \frac{fr\; L_i\; \cos\theta_{ik}}{pdf( \omega_{ik})}
$$


## shadow ray

基本思路是，将渲染方程拆分为直接光照和间接光照两项，每次反射时发射两根光线：

- scatter ray ：朝非光源发射
- shadow ray：朝光源发射

对应的渲染方程如下：

$$
L_o = \int_{H^2}g_1(\omega_i)\; fr\; L_i\; \cos\theta_i\; d\omega_i 
+ \int_{H^2}g_2(\omega_i)\; fr\; L_i\; \cos\theta_i\; d\omega_i 
$$

其中：$g_1(\omega_i)$ 为：如果入射光直接来自光源，那么函数值为 1，否则为 0；$g_2(\omega_i)$ 的作用类似。

使用 Monte Carlo 方法来计算两个积分即可。

### 计算直接光照

通常来说，计算直接光照的积分范围可以不再是整个半球，而是光照面积的投影部分。

如果采取这样的随机采样策略：在光源面积上随机取一点，那么随机变量 $\omega_i$ 的概率密度函数为：

![[图形学/离线渲染/_attachments/Pasted image 20221205180212.png | 600]]


因此，直接光照使用 Monte Carlo 方法这样计算：

$$
L_o = \frac{1}{n}\sum_{k=1}^n g_1(\omega_i)\; fr\; L_i\; \cos\theta_{ik}
\cdot \frac{A\; \cos\alpha}{distance^2}
$$

无论途中是否被遮挡，每次选择的散射方向都是朝向光源方向的。


## mix pdf 方法

Monte Carlo 方法的概率密度函数是可以随意选择的，只要确保随机变量 $\omega_i$ 的取值范围与积分的范围相同即可。

那么可以按照以下策略来选择散射方向：

- 有 $50\%$ 的概率使用 pdf-1 来决定（例如基于光源采样）
- 有 $50\%$ 概率使用 pdf-2 来决定（例如 Lambert 的 $\cos\theta/\pi$ 概率密度采样）

那么某个方向 $\omega_i$ 所对应的概率密度为：

$$
pdf(\omega_i) = 0.5 * pdf_1(\omega_i) + 0.5 * pdf_2(\omega_i)
$$


