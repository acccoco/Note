## 差分数组

差分数组擅长<span style="background:yellow;">区间修改</span>



## 差分树状数组：区间修改和区间查询

定理推导：

> 设`A[i]`是原数组，`D[i]`是差分数组。
>
> 那么前缀和可以表示为：
> $$
> \sum_{i=1}^{n}A[i] = (D[1]) + (D[1] + D[2]) +...+(D[1] +...+D[n])\\
> =n\sum_{i=1}^{n}D[i]-\sum_{i=1}^{n}(i-1)D[i]
> $$

那么，可以设置一个数组`D2[i]=(i-1)*D[i]`。在`D[i]`和`D2[2]`之上建立树状数组，即可实现在$O(logn)$的时间里区间修改和区间查询。

```cpp
// 注意：下标仍然从1开始
vector<int> A;		// 原数组
vector<int> D;		// 差分数组
vector<int> D2;		// D2[i] = (i - 1) * D[i]

// 修改树状数组一个结点
void UpdatePoint(vector<int> a, int i, int delta) {
    while (i < n) {
    	a[i] += delta;
        i += i & (-i);
    }
}
// 数组求和
int sum(vector<int> a, int r) {
	int ans = 0;
   	for (int i = 1; i <= r; ++i) {
    	ans += a[i];
    }
}
// 结构初始化
void Init() {
	for (int i = 1; i < n; ++i) {
    	UpdatePoint(D, i, A[i] - A[i - 1]);
        UpdatePoint(D2, i, (i - 1)(A[i] - A[i - 1]));
    }
}
// 区间修改
void UpdateIntreval(int l, int r, int delta) {
	UpdatePoint(D, l, delta);
    UpdatePoint(D, r + 1, -delta);
    UpdatePoint(D2, l, (l - 1) * delta);
    UpdatePoint(D2, r + 1, r * (-delta));
}

// 区间查询
int IntervalSum(int l, int r) {
	int sum1 = (l - 1) * sum(D, l - 1) - sum(D2, l - 1);
    int sum2 = r * sum(D, r) - sum(D2, r);
    return sum2 - sum1;
}
```

