流水线的思想：将一条指令的指令过程分为多个部分，同一时刻每个部分对应的执行元件都在工作。

如图：将一条指令的执行过程分为 4 个部分，同一时刻，有 4 条指令正在被执行。理想情况下，每个时钟周期，CPU 可以执行完成一条指令，因此 $CPI = 1$  
![[不活跃主题/计算机组成原理/中央处理器/_attachments/1634907362270-f9175fa1-c7e6-4cfe-90a2-f49fd6d40cef.png | 460]]

流水线应该分为多少段：按照最复杂的指令来分割
每一段流水的时间为多少：以最复杂的步骤为基准

**流水线并不会缩短一条指令的执行时间，但会增加吞吐量**：

- 假设一条指令的执行情况：取指 200，分析 100，执行 150，顺序执行的总时间为 **450**
- 流水线分为 3 段，每段的时间都是 200，那么一条指令的执行时间就是 **600**，更长了
- 理想情况下，每 **200 **时间就可以执行完一条指令，吞吐量增加了

流水线各个功能部件后面都有一个「**锁存器**」，用于保存本段的执行结果，供下一段使用。


### 流水线冲突
以下三种情况会影响流水线的性能，可能导致断流。

**资源冲突**：例如同时进行一条指令的「取指」过程和另一条指令的「取数」过程，两者都会访问主存，因此发生冲突。可以为指令和数据分别设置存储器来解决这个问题，例如一级缓存分为「指令缓存」和「数据缓存」。

**数据冲突**：前一条指令的某个数据和后一条指令的数据相关。

- 先读后写（WAR）的相关性：指令 `(**R3**) -> M(x)` 和 `(R4 + R5) -> **R3**`，前一条指令先读 `R3`，后一条指令写 `R3` 
- 先写后读（RAW）的相关性：指令 `(R2 + R3) -> **R1**` 和 `(**R1** - R5) -> R4` 
- 写后写（WAW）的相关性：指令 `(R1) x (R2) -> **R3**` 和 `(R4 + R5) -> **R3**`

顺序执行的流水线中，只会发生 **RAW** 的冲突。
解决办法是：

1. 如果发生数据相关，就让后续的指令延后执行
2. 旁路技术：不必等待上一条数据写回到寄存器，下一条指令可以直接得到上一条的运算结果

**控制冲突**：转移指令引起的。造成的流水线损失如图：
![[不活跃主题/计算机组成原理/中央处理器/_attachments/1634908572028-45e01bc0-bdf6-4930-a69f-53c106ab6b42.png | 406]]

解决办法是：

1. 更快地形成条件码
2. 分支预测技术


### 流水线的多发技术
**超标量**：
同时存在多条流水线，需要多个功能部件。最终可以实现一个时钟周期完成多个指令。
例如，如下的代码段：
```c
MOV BL, 8
ADD AX, 1756H
ADD CL, 4EH
```

这三行指令不存在数据相关，完全可以并行执行。
超标量技术需要编译器的配合。


