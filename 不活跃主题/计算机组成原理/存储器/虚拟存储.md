
## 虚拟存储的基本原理
虚拟存储是由「主存」和「辅存」共同构成的存储器，相关的操作由「**硬件**」和「**软件**」共同实现。

**逻辑地址与物理地址**：
每个应用程序都有一个独立的地址空间，叫做「虚拟空间/程序空间」，其中的地址叫做「虚地址/逻辑地址」；
实际的主存的地址叫做「物理地址/实地址」，对应的地址空间叫做「实地址空间」；

**CPU 访问程序地址空间的过程涉及**：

- **地址转换**：首先将「逻辑地址」转换为「物理地址」，然后访问
- **调入**：如果「逻辑地址」对应的存储单元并不在「主存」中，则需要先从「辅存」调入「主存」
- **置换**：在「调入」的过程中，如果「主存」已满，则需要淘汰掉「主存」的某个页/段


## 页式虚拟存储器
「主存」和「逻辑空间」都被划分为大小相等的「页」，通过「页表」实现从「逻辑地址」到「物理地址」的转换。

**逻辑地址的组成**：

- 页面地址：共 k 位，满足页面的大小为 $2^k$  

![[不活跃主题/计算机组成原理/存储器/_attachments/1634395966943-9eedbf4e-dadf-41c5-b407-b2de742b53c9.png | 469]]


### 页表
**页表的工作原理**：

- 通过「逻辑地址」的「虚拟页号」可以唯一找到页表中的某一个「页表项」
- 检查「页表项」，判断对应的页是否装入主存；
   - 如果已装入，那么可以获得对应的「物理页号」；和「页内地址」拼接起来就可以得到「物理地址」
   - 如果未装入，就处罚「缺页中断」，由「**操作系统**」负责装入

**页表基址寄存器**：
每个应用程序有自己的页表，可以通过「页表基址寄存器」来找到。
![[不活跃主题/计算机组成原理/存储器/_attachments/1634396489884-ddb34561-34aa-44af-a97d-35225bb286f1.png | 374]]

**快表 TLB**：
为了加快地址转换的速度，可以缓存经常使用的「页表项」，将其放入「快表」中。
「快表」是硬件实现的，有「全相联」和「组相联」两种组织方式。

对与「组相联」的快表组织方式，可以通过「虚拟页号」计算出对应的「快表」的组，然后在组内进行查找「页表项」。


## 段式虚拟存储器
「段式虚拟存储器」按照程序的逻辑段来划分「虚存空间」。
「逻辑地址」的组成为：
![[不活跃主题/计算机组成原理/存储器/_attachments/1634397150771-63161933-2020-4d69-a542-4f681e9b0da8.png | 481]]

**访问过程为**：

- 由于段长并不是相等的，因此需要在段表中给出段的「首地址」和「段长」

![[不活跃主题/计算机组成原理/存储器/_attachments/1634396991988-8262047d-4e8e-4162-ab5c-e44ea8e6ea1b.png | 349]]


## 段页式虚拟存储器
「页式虚拟存储器」是的每一页大小相等，页并不是按照逻辑划分的，不利于程序的保护和共享。
「段式虚拟存储器」的段大小不同，空间不方便分配，容易留下碎片。

「段页式虚拟存储器」将程序按照逻辑段进行划分，每个段划分为大小固定的页，段的大小是页大小的整数倍。每个程序对应一个「段表」，每个段对应一个「页表」。

注：对于「段页式虚拟存储器」，调入和调出主存的基本单位是页

**「虚拟地址」的结构**：
![[不活跃主题/计算机组成原理/存储器/_attachments/1634397634173-4644a1b6-dc5c-44ec-b367-b8ca884aaa97.png | 479]]

**内存访问的过程**：

- 首先根据「段表」和「段号」得到「页表」的地址
- 查询「页表」，根据「页号」得到物理页的地址
- 合成「物理页」的地址和「也内地址」，得到最终的「物理地址」

