> 
##### 摘要：
> 本文主要介绍了aSAN中的分层技术
> - 首先介绍了SSD的空间划分
> - 然后介绍了分层的作用，以及分层如何参与到读写的过程中来
> - 之后介绍了数据读取的一般过程

[toc]

#### _SSD_ 的空间划分
_SSD_ 被划分为 _3_ 个部分：分层（_Tier_）区，读缓存区，写缓存区

- 分层：主要为本地读/写提供缓存功能
- 读缓存：缓存非本地的数据
- 写缓存：为小块数据提供写缓存

![[不活跃主题/云计算/_attachments/1600055499057-31691522-61f9-4606-9364-c7472ec79771.png ]]

#### 分层的工作原理
分层的作用是：分层位于 _SSD_ 中，为同一个磁盘组中的 _HDD_ 提供读写缓冲的能力。分层并不区分读缓存和写缓存
还需要介绍一个概念：

- 容量层：_HDD_ 被称为容量层，容量层中应该有完整的数据（当分层中的数据全部写回到容量层中时）

##### 数据写入的过程：

- 将数据写入到分层中，然后调用返回成功
- 分层中的数据会被持续写入到容量层中。未被写入到容量层中的数据叫做 _dirty_ 数据，成功写入到容量层中的数据是 _clean_ 数据
- 继续写入，直到分层写满，某些 _clean_ 数据会被淘汰掉（擦除掉）

![[不活跃主题/云计算/_attachments/1600055499100-0c3a1a7d-1276-4ec0-b03b-783f37e7af10.png ]]
注：多副本（多磁盘组）情形下，分层中的状态是不同的，以下情形是允许的：

- 数据 _x_ 在磁盘组 _A_ 的分层中是 _dirty_，在磁盘组 _B_ 的分层中是 _clean_
- 数据 _x_ 在磁盘组 _A_ 只存在于容量层（_clean_ 被淘汰）；在磁盘 _B_ 中既存在于分层，又存在于容量层

##### 数据读取的过程
分层提供读缓存的功能；

- 如果分层中的数据命中，则成功返回
- 如果分层的缓存未命中，会将未命中的数据及周围数据放入到分层中

##### 数据热度
分层使用数据热度的机制，热度是数据淘汰的依据
热度：根据被访问次数和最近被访问的时间来区分数据的冷热

#### 数据读取的一般过程
分层主要是本地数据的读写缓存。缓存作用除了分层区提供，以下两个分区也提供：

- 写缓存：提升小块数据（小于 _4KB_）的写入效率

- 读缓存：缓存非本地数据


读操作的过程：`本地Tier -> 本地HDD -> 读缓存 -> 其他主机的Tier -> 其他主机的HDD`
