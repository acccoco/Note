

[toc]



#### <span style="color:#0202c0;">磁盘结构</span>

##### 磁盘的物理结构

可以通过三元组 `<磁头，柱面，扇区>` 来唯一定义磁盘上的一个扇区。

扇区：磁盘的最小读写单位是一个扇区

逻辑扇区：磁盘的物理扇区大小有 _512B_ 和 _4KB_，为了实现兼容，磁盘会给操作系统展示逻辑扇区。一个逻辑扇区通常包含 $2^n$ 个逻辑扇区，当要读写某个逻辑扇区时，磁盘底层实际会读写逻辑扇区所在的==整个物理扇区==。

簇：簇是文件系统的概念。扇区太小，文件系统为了方便管理，会在扇区的基础上形成簇，一个簇通常包含 $2^n$ 个扇区。

![[不活跃主题/操作系统/文件/_attachments/Pasted image 20221101014411.png]]



##### 磁盘扇区的寻址方式

###### _CHS_ 寻址方式：

使用 `<cylinder柱面, HEAD磁头, sector扇区>` 的方式来定位一个扇区，这种寻址方式又称为 ==_3D_== 的寻址方式。

限制：使用 `10bit` 来表示柱面，`8bit` 来表示磁头，`6bit` 来表示扇区，假定一个扇区的大小为 `512B`，那么这种方式只能寻址 `8G` 大小的磁盘，==容量限制==。

另一个限制：_CHS_ 只能用于 _HDD_ 的寻址，不能用于其他设备，如网络，磁带的寻址，比较有==局限性==。



###### _LBA（logical block addressing）_寻址方式

由于 _CHS_ 的大小限制，_LBA_ 被提出了。_CHS_ 中每一个扇区的地址是三维的，_LBA_ 使用==一维线性==的地址来定位每一个扇区。

硬盘控制器可以识别 _LBA_ 地址。

_LBA_ 地址的计算/**映射**方式：

![[不活跃主题/操作系统/文件/_attachments/Pasted image 20221101014513.png]]


其中：

- _HPC_ 表示每个柱面的磁头数量（_heads per cylinder_）
- _SPT_ 表示每个磁道的扇区数量（_sectors per track_）
- _HPC_ 和 _SPT_ 都是通过==磁盘驱动器==的报告得到

可以看到，第一个扇区为 _LBA 0_



##### 为什么要 _4K_ 对齐

磁盘的规格：

- _512n, native_：物理扇区和逻辑扇区的大小都是 _512B_.
- _512e, emulation_：物理扇区大小为 _4KB_，逻辑扇区大小为 _512B_. 
- _4Kn_：物理扇区和逻辑扇区的大小都为 _4KB_.

_4K_ 对齐是==分区==时候需要注意的事情。

分区是将磁盘上一片连续的扇区划分为一个区域；

簇/块：扇区实在是太小了，我呢见系统会使用簇/块作为最小的单位，格式化会扇区划分为==簇==。

对于一个 _512e_ 的磁盘，如果在分区时，起始位没有和物理扇区的边缘对齐，那么格式化后的簇也无法和物理扇区对齐：

![[不活跃主题/操作系统/文件/_attachments/Pasted image 20221101014418.png]]


如果磁盘想要向某个逻辑扇区写入，由于最小的读写单位是一个物理扇区，所以磁盘会先读取再写入，这样效率比较低。



#### <span style="color:#0202c0;">硬盘接口，总线和协议</span>

<b style="color: red">这一块非常混乱，有待解决</b>

PCIE：是一切接口的源头，各种接口，比如网卡，USB，显卡等都是由PICIE演化过来的。



##### 接口分类

- PATA：硬盘的接口，并行的ATA接口，也使用IDE来指代这种接口，速度较慢，已被淘汰。

- ==SATA==：硬盘的接口，串行的ATA接口
- ==SCSI==：硬盘的接口，一般用于服务器
- ==SAS==：串行的SCSI，一般用于服务器
- FC：Fibre Channel，使用光纤的硬盘，高端
- PCI-e接口。。。
- M.2接口：一般用于笔记本的固态硬盘，支持 _NVMe_ 协议
- U.2接口：多用于服务器的接口，支持 _NVMe_ 协议


![[不活跃主题/操作系统/文件/_attachments/Pasted image 20221101014425.png]]


##### 硬盘传输的协议：

- IDE协议：很老牌的协议
- AHCI：是一种协议，SATA接口就是使用这种协议
- NVMe：是一种协议，为了发挥固态硬盘的速度优势而出现。使用NVMe协议的设备需要直接连接到PICE总线上。

注：IDE：Integrated Drive Electronics，电子集成驱动器，本意是指把“硬盘控制器和盘体结合在一起的硬盘。



iSCSI：将SCSI和IP结合起来，使服务器可以通过网络进行SCSI传输。iSCSI是一种==协议==。