**待整理**

## 操作系统引导
区别以下几类概念

- 固件：BIOS，UEFI：为什么叫固件，因为是烧写在记忆体里面的。
- 分区表：MBR，GPT：这个是给谁使用的？
- 文件系统：FAT，NTFS，EXT
- 加载引导器：GRUB，easyBCD

### **查看引导代码**

- 查看/dev/sda1或者/dev/sdb1第一个扇区的内容
- 将扇区内容读入文件：`dd if=/dev/sda1 of=mbr.bin skip=0 bs=512 count=1`
- 将二进制内容翻译为16位汇编：`objdump -D -b binary -m i8086 --start-address=0x54 mbr.bin >> mbr.s`
- `hd`指令可以用16进制形式查看binary文件

### **解读引导代码**

- **16位情况**：内存地址空间为1MB，BIOS被编址在地址最高的64KB，也就是从`0xf0000`到`0xfffff`。CPU启动后会自动从`0xffff0`处执行指令，这条指令是BIOS的ROM中的指令，这通常是一条跳转指令。跳转到`0xfe05b`处开始BIOS的执行。

- **32位情况**：内存地址空间为4GB，BIOS仍被编址在最高的64KB中，也就是从`0xffff0000`到`0xffffffff`。CPU启动会从`0xfffffff0`处执行。intel采用了一种映射机制，将高端的BIOS ROM映射到低端的1MB之内的RAM中，并使内存具有只读属性。这样可以保持良好的兼容。

- 在16位实模式下，第一扇区内的代码会被BIOS加载到`0x7c00`处，并开始执行

- 这个应该不是MBR分区，因为最后的66个字节不是分区表DPT（disk partition table），而是部分被字符串占用了

- 使用qemu加载运行`qemu-system-i386 -hda mbr.bin`结果为：
![[不活跃主题/操作系统/操作系统/_attachments/1600092886377-cea61447-9793-47a4-9b53-978c0c1b8f22.png | 721]]

### **[boot loader]**

- 引导情况为：BIOS  -> boot loader -> OS
- boot loader就是位于第一个扇区中的内容。单步引导程序就512B大，两步（甚至三部）引导程序使用第一步来引导第二部。`GRUB`就是多部引导程序。还有一类引导程序是单步引导，第一扇区中的内容可以加载剩余的程序到内存中。
- 关于`GRUB`
   - 对于BIOS+MBR，可以将第一扇区设置引导`GRUB`
   - 对于UEFI+GPT，uefi的shell会检测并使用xx.efi文件加载`GRUB`，然后由`GRUB`来引导操作系统

### **BIOS与UEFI**

- BIOS加载第一扇区，第一扇区内容作为引导代码或者引导器（GRUB）的第一步
- UEFI的内容位于ROM中，并且需要一个GPT下的FAT32分区的EFI文件系统，该文件系统用于放一些xx.efi文件，可以使用这些文件直接引导操作系统，也可以使用xx.efi来加载某些引导器，如GRUB，然后由GRUB来引导系统

### **分区表**

- `分区`，`文件系统`，`系统引导`这三个概念是紧密联系在一起的。

- `MBR（Master Boot Record）`：将分区内容放在硬盘第一个扇区的后64字节中（55 aa除外），只允许4个分区（或者设置某个分区为扩展分区，在扩展分区中创建逻辑分区），切每个分区大小最多2TB（使用4字节存放扇区数目）。分区表DPT（disk partition table）的表项长度为16字节，存有分区类型（FAT，NTFS，扩展分区等），活动标志，起始位置，分区长度等信息。
	![[不活跃主题/操作系统/操作系统/_attachments/1600092886408-bad8bc56-255e-46bd-ba3a-d6e421fd2015.jpeg | 315]]

- `GPT（global-uni-id Partition Table）`
   - 为每一个分区分配一个GUID（globally unique identifier），分区表具有冗余备份。
   - 兼容性：在使用不支持GPT的分区工具时，PMBR就起作用了，将整个硬盘显示为一个受保护的分区，防止数据被轻易修改。

![[不活跃主题/操作系统/操作系统/_attachments/1600092886469-87ca0c7d-c17b-4da3-b2c1-cc8474b65f0c.jpeg | 298]]


### **文件系统**

- 文件系统是对应分区的，而不是对应硬盘的。同一块硬盘上的不同分区可以有不同的文件系统。
- inode位于ext分区中
